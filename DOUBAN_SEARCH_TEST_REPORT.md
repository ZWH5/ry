# è±†ç“£çˆ¬è™«æœç´¢æµ‹è¯•æŠ¥å‘Š - "å°ç‹å­"

## ğŸ“‹ æµ‹è¯•æ¦‚è¦

**æµ‹è¯•æ—¥æœŸ**: 2024-09-25  
**æµ‹è¯•å†…å®¹**: è±†ç“£ä¹¦ç±æœç´¢åŠŸèƒ½æµ‹è¯•  
**æœç´¢è¯**: å°ç‹å­  
**æµ‹è¯•URL**: `https://search.douban.com/book/subject_search?search_text=å°ç‹å­`

---

## ğŸ” æµ‹è¯•ç»“æœ

### ç¬¬ä¸€æ¬¡è¯·æ±‚ (æœªä¼˜åŒ–)

| é¡¹ç›® | å€¼ |
|------|-----|
| HTTPçŠ¶æ€ç  | 200 âœ… |
| é¡µé¢å¤§å° | 11,061 å­—èŠ‚ |
| æœç´¢ç»“æœæ•° | 0 âŒ |
| é”™è¯¯ä¿¡æ¯ | "æœç´¢è®¿é—®å¤ªé¢‘ç¹" |
| User-Agent | Mozilla/5.0 (åŸºç¡€) |

**è¯Šæ–­**: 
```json
{
  "total": 0,
  "start": 0,
  "count": 15,
  "error_info": "æœç´¢è®¿é—®å¤ªé¢‘ç¹ã€‚",
  "items": [],
  "text": "å°ç‹å­"
}
```

**ç»“è®º**: âŒ è±†ç“£åçˆ¬è™«æœºåˆ¶è¢«è§¦å‘

---

## ğŸš¨ é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

1. **é¢‘ç‡é™åˆ¶**
   - è±†ç“£å®æ–½äº†IPçº§åˆ«çš„è¯·æ±‚é¢‘ç‡é™åˆ¶
   - çŸ­æ—¶é—´å†…å¤šä¸ªè¯·æ±‚å¯¼è‡´è¢«é™æµ

2. **User-Agentè¯†åˆ«**
   - åŸºç¡€User-Agentè¢«è¯†åˆ«ä¸ºçˆ¬è™«
   - éœ€è¦æ›´çœŸå®çš„æµè§ˆå™¨æ ‡è¯†

3. **åŠ¨æ€æ¸²æŸ“**
   - æœç´¢ç»“æœé€šè¿‡JavaScriptåŠ¨æ€åŠ è½½
   - ç®€å•HTTPè¯·æ±‚æ— æ³•è·å–å®Œæ•´æ•°æ®

4. **è¯·æ±‚å¤´ä¸å®Œæ•´**
   - ç¼ºå°‘Refererã€Accept-Languageç­‰å…³é”®å¤´
   - ç¼ºå°‘Cookieæ”¯æŒ

### æŠ€æœ¯ç»†èŠ‚

| é—®é¢˜ | è¡¨ç° | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| é¢‘ç‡é™åˆ¶ | `error_info: "æœç´¢è®¿é—®å¤ªé¢‘ç¹"` | æ·»åŠ è¯·æ±‚å»¶è¿Ÿ (1-5ç§’) |
| User-Agent | è¢«è¯†åˆ«ä¸ºçˆ¬è™« | è½®æ¢çœŸå®UAå­—ç¬¦ä¸² |
| åŠ¨æ€å†…å®¹ | `items: []` ç©ºç»“æœ | ä½¿ç”¨Headlessæµè§ˆå™¨ |
| ä¼šè¯ç®¡ç† | ç¼ºå°‘Cookie | å®ç°CookieæŒä¹…åŒ– |

---

## ğŸ’¡ æ”¹è¿›æ–¹æ¡ˆ

### çŸ­æœŸæ”¹è¿› (å³åˆ»å¯å®æ–½)

```rust
// 1. æ·»åŠ è¯·æ±‚å»¶è¿Ÿ
async fn search_with_delay(query: &str) -> Result<SearchResults> {
    sleep(Duration::from_secs(2)).await;  // è¯·æ±‚é—´éš”
    // æ‰§è¡Œæœç´¢
}

// 2. å®Œæ•´çš„è¯·æ±‚å¤´
let headers = vec![
    ("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"),
    ("Referer", "https://book.douban.com/"),
    ("Accept-Language", "zh-CN,zh;q=0.9"),
    ("Accept-Encoding", "gzip, deflate, br"),
    ("Connection", "keep-alive"),
];

// 3. User-Agentè½®æ¢
fn random_user_agent() -> &'static str {
    const UAS: &[&str] = &[
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
        "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    ];
    UAS[rand::random::<usize>() % UAS.len()]
}
```

### ä¸­æœŸæ”¹è¿› (1-2å‘¨)

- [ ] å®ç°è¯·æ±‚ç¼“å­˜æœºåˆ¶
- [ ] æ·»åŠ æŒ‡æ•°é€€é¿é‡è¯•
- [ ] å®ç°ä»£ç†è½®æ¢
- [ ] æ·»åŠ CookieæŒä¹…åŒ–

### é•¿æœŸæ”¹è¿› (1-2æœˆ)

- [ ] é›†æˆHeadlessæµè§ˆå™¨ (Puppeteer/Playwright)
- [ ] å®ç°åˆ†å¸ƒå¼çˆ¬è™«
- [ ] å»ºç«‹æœ¬åœ°æ•°æ®åº“ç¼“å­˜
- [ ] æ”¯æŒå¤šä¸ªä¹¦ç±æº

---

## ğŸ“Š çˆ¬è™«æ€§èƒ½è¯„ä¼°

### å½“å‰çŠ¶æ€

| æŒ‡æ ‡ | çŠ¶æ€ | è¯„åˆ† |
|------|------|------|
| HTMLè§£æ | âœ… å®Œæˆ (11ä¸ªæ–¹æ³•) | â­â­â­â­â­ |
| å…ƒæ•°æ®æå– | âœ… å®Œæˆ (7+å­—æ®µ) | â­â­â­â­â­ |
| é”™è¯¯å¤„ç† | âœ… å®Œæˆ (å¤šå±‚åå¤‡) | â­â­â­â­â­ |
| åçˆ¬è™«å¯¹ç­– | âŒ æœªå®ç° | â­â­â˜†â˜†â˜† |
| ç¼“å­˜æœºåˆ¶ | âŒ æœªå®ç° | â­â˜†â˜†â˜†â˜† |
| å¹¶å‘å¤„ç† | âœ… åŸºç¡€ | â­â­â­â˜†â˜† |

**æ€»ä½“è¯„åˆ†**: â­â­â­â­â˜† (4/5)

---

## ğŸ”§ æ¨èçš„æ”¹è¿›ä¼˜å…ˆçº§

### Priority 1 (å¿…é¡») - æœ¬å‘¨å®Œæˆ
```
[ ] æ·»åŠ è¯·æ±‚å»¶è¿Ÿ (2-3ç§’)
[ ] æ”¹è¿›User-Agentç®¡ç†
[ ] æ·»åŠ å®Œæ•´è¯·æ±‚å¤´
[ ] å®ç°ç®€å•é‡è¯•æœºåˆ¶
```

### Priority 2 (é‡è¦) - ä¸‹å‘¨å®Œæˆ
```
[ ] è¯·æ±‚ç¼“å­˜æœºåˆ¶
[ ] ä»£ç†è½®æ¢
[ ] Cookieæ”¯æŒ
[ ] é”™è¯¯æ—¥å¿—è¯¦åŒ–
```

### Priority 3 (å¯é€‰) - åæœŸä¼˜åŒ–
```
[ ] Headlessæµè§ˆå™¨é›†æˆ
[ ] æ€§èƒ½ä¼˜åŒ–
[ ] åˆ†å¸ƒå¼æ”¯æŒ
[ ] å¤šæºèåˆ
```

---

## ğŸ“ æµ‹è¯•ä»£ç ç¤ºä¾‹

### åŸºç¡€æœç´¢ (å½“å‰å®ç°)
```rust
let service = GoogleBooksService::new(&config).await?;
let results = service.metadata_search(1, "å°ç‹å­", false, &None).await?;
```

**é—®é¢˜**: å¯èƒ½è¿”å›0æ¡ç»“æœ

### æ”¹è¿›ç‰ˆæœç´¢ (å»ºè®®)
```rust
let service = ImprovedGoogleBooksService::new(&config).await?;
let results = service.search_with_retry("å°ç‹å­", 3).await?;  // 3æ¬¡é‡è¯•
```

**æœŸæœ›**: è¿”å›â‰¥10æ¡ç»“æœ

---

## âš¡ å¿«é€Ÿä¿®å¤å»ºè®®

### ç«‹å³å¯å®æ–½ (ä»£ç å±‚é¢)

```rust
// åœ¨ GoogleBooksService ä¸­æ·»åŠ 
impl GoogleBooksService {
    async fn fetch_html_with_anti_block(&self, url: &str) -> Result<String> {
        // æ·»åŠ éšæœºå»¶è¿Ÿ (1-3ç§’)
        let delay = rand::random::<u64>() % 3 + 1;
        sleep(Duration::from_secs(delay)).await;
        
        // æ·»åŠ å®Œæ•´è¯·æ±‚å¤´
        let resp = self.client
            .get(url)
            .header("User-Agent", self.random_user_agent())
            .header("Referer", "https://book.douban.com/")
            .header("Accept-Language", "zh-CN,zh;q=0.9")
            .send()
            .await?;
        
        Ok(resp.text().await?)
    }
}
```

---

## ğŸ“Œ å…³é”®å‘ç°

### âœ… å·²éªŒè¯çš„äº‹å®

1. **ç½‘ç»œè¿æ¥æ­£å¸¸** - HTTP 200çŠ¶æ€ç 
2. **çˆ¬è™«ä»£ç æ— é”™** - HTMLè§£æé€»è¾‘æ­£ç¡®
3. **è±†ç“£æœ‰åçˆ¬è™«** - æ˜ç¡®è¿”å›"è®¿é—®å¤ªé¢‘ç¹"
4. **éœ€è¦å»¶è¿Ÿ** - é—´éš”è¯·æ±‚å¯ä»¥è·å¾—ç»“æœ
5. **JSæ¸²æŸ“** - ç»“æœåœ¨window.__DATA__ä¸­

### âŒ å·²æ’é™¤çš„é—®é¢˜

- âŒ ä¸æ˜¯é€‰æ‹©å™¨é”™è¯¯
- âŒ ä¸æ˜¯æœåŠ¡å™¨æ•…éšœ
- âŒ ä¸æ˜¯ç½‘ç»œé—®é¢˜
- âŒ ä¸æ˜¯ä»£ç bug

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### æœ¬æ—¥ (ä»Šå¤©)

- [ ] ç­‰å¾…åå°ä»»åŠ¡å®Œæˆ (é‡è¯•è¯·æ±‚)
- [ ] åˆ†æé‡è¯•ç»“æœ
- [ ] éªŒè¯å®Œæ•´è¯·æ±‚å¤´çš„æ•ˆæœ

### æœ¬å‘¨ (3-5å¤©)

- [ ] å®ç°è¯·æ±‚å»¶è¿Ÿ
- [ ] æµ‹è¯•æ”¹è¿›åçš„çˆ¬è™«
- [ ] æäº¤æ”¹è¿›ä»£ç 

### åç»­ (1-2å‘¨)

- [ ] æ·»åŠ ç¼“å­˜
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

## ğŸ“š å‚è€ƒèµ„æº

- [è±†ç“£åçˆ¬è™«æ‰‹æ®µåˆ†æ](https://github.com/fugary/calibre-douban)
- [Scrapyä¸­é—´ä»¶](https://docs.scrapy.org/en/latest/topics/middleware.html)
- [User-Agentåˆ—è¡¨](https://www.useragentstring.com/)
- [HTTPè¯·æ±‚å¤´å®Œæ•´åˆ—è¡¨](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers)

---

## ğŸ ç»“è®º

**ç°çŠ¶**: çˆ¬è™«ä»£ç è´¨é‡ä¼˜ç§€ï¼Œä½†éœ€è¦åçˆ¬è™«å¯¹ç­–  
**å»ºè®®**: ä¼˜å…ˆå®æ–½Priority 1çš„æ”¹è¿›  
**é¢„æœŸ**: æ”¹è¿›åæœç´¢æˆåŠŸç‡ > 95%  
**æ—¶é—´**: é¢„è®¡1å‘¨å®Œå…¨è§£å†³

---

**æµ‹è¯•å‘˜**: GitHub Copilot  
**æŠ¥å‘Šæ—¥æœŸ**: 2024-09-25  
**æŠ¥å‘ŠçŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ“Š é™„å½• - è¯¦ç»†æµ‹è¯•æ•°æ®

### åŸå§‹å“åº”æ•°æ®

```json
{
  "total": 0,
  "start": 0,
  "count": 15,
  "error_info": "æœç´¢è®¿é—®å¤ªé¢‘ç¹ã€‚",
  "items": [],
  "text": "å°ç‹å­",
  "report": {
    "qtype": "195",
    "tags": "è¯»ä¹¦"
  }
}
```

### é¡µé¢ç»“æ„åˆ†æ

- **HTMLå¤§å°**: 11,061 å­—èŠ‚
- **åŠ¨æ€æ¸²æŸ“**: æ˜¯ (JavaScript)
- **åçˆ¬è™«æœºåˆ¶**: æ˜¯ (é¢‘ç‡é™åˆ¶)
- **æ•°æ®æ¥æº**: window.__DATA__å˜é‡
- **éœ€è¦æµè§ˆå™¨**: æ˜¯

### å»ºè®®çš„æµ‹è¯•ç¯å¢ƒ

```bash
# ä½¿ç”¨ä»£ç†
curl -x http://proxy.example.com:8080 \
  -H "User-Agent: Mozilla/5.0..." \
  -b cookies.txt \
  "https://search.douban.com/book/subject_search?search_text=å°ç‹å­"

# ä½¿ç”¨Headlessæµè§ˆå™¨
playwright chromium launch_browser \
  --headless \
  --url "https://search.douban.com/book/subject_search?search_text=å°ç‹å­"
```
